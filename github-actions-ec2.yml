# Trigger deployment only on push to master branch
on:
  push:
    branches:
      - main
jobs:
    build:
      runs-on: ubuntu-latest

      steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          extensions: mbstring, pdo, pdo_mysql, xml
          ini-values: post_max_size=256M, upload_max_filesize=256M

      - name: Install dependencies
        run: composer install --no-dev --prefer-dist --optimize-autoloader

      - name: Run tests
        run: php artisan test
   
   deploy:
     runs-on: ubuntu-latest
     needs: build
    
     steps:
      - name: Checkout code
        uses: actions/checkout@v3
        
      - name: Deploy to EC2
        env:
          EC2_SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
          HOST_DNS: ${{ secrets.HOST_DNS }}
          USERNAME: ${{ secrets.USERNAME }}
          TARGET_DIR: ${{ secrets.TARGET_DIR }}
        run: |
          echo "Hello-3"
         
          echo "${EC2_SSH_KEY}" > deploy_key.pem
          chmod 600 deploy_key.pem
        
          ssh -o StrictHostKeyChecking=no -i deploy_key.pem $USERNAME@HOST_DNS << 'EOF'
           cd /var/www/Laravel-Demo
           git pull origin main
           composer install --no-dev --prefer-dist --optimize-autoloader
           php artisan migrate --force
           php artisan config:cache
           php artisan route:cache
           php artisan view:cache
           sudo systemctl restart httpd # or nginx
          EOF

    - name: Cleanup
      run: rm deploy_key.pem
          
